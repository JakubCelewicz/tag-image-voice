<!DOCTYPE html>
<html>
<head>
    <!--<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>-->
    <script src="https://unpkg.com/vue@latest"></script>
    <script src="https://unpkg.com/vue-select@latest"></script>
    <style type="text/css">
        body {
            text-align: center;
            font-size: 18px;
        }
        section { padding: 10px }
        .image_container {
            padding: 5px;
        }
        .included {
            background-color: black;
            color: white;
        }
        .selected {
            border: 2px solid blue;
        }
        .disabledDiv {
            opacity: 0.5;
            pointer-events: none;
            padding: 10px;
        }
        .filter-wrapper {
            background: azure;

        }
        .dropdown {
            float: right;
            width: 150px;
        }
        .tags { padding: 10px }
        .images > div { display: inline; padding: 10px;}
        .tag {
            padding: 10px;
            display: inline;
        }
    </style>
</head>
<body>
<div id="app">
    <input class="form-control" placeholder="add new tag" v-model="newStore" @keydown.enter="addStore"/>
    <section class="tags">
        <tags v-for="item in tags" v-bind:store="item.text" v-bind:key="item.index" class="tag"> </tags>
        <v-select v-model="filtered" :options="getTags()"></v-select>
    </section>
    <section class="images">
        <images v-for="item in filteredImages || images" v-bind:image="item" v-bind:key="item" @selected="selectImage(item)"></images>
    </section>
    <section>
        <download v-bind:store="tags"> download file</download>
    </section>

</div>

<script type="text/javascript">
    const images = ['image1.jpg', 'image2.jpg', 'image3.jpg'];

    Vue.component('images', {
        props: ['image'],
        template: `
          <div class="image_container">
            <label>
                <img src="https://via.placeholder.com/100x100"
                     v-bind:id=image
                     alt:image
                     title:image
                     @click="selected"
                     v-bind:class="{ selected: isSelected() }"
                 />
            </label>
          </div>
          `,
        methods: {
            selected() { this.$emit('selected') },
            isSelected() { return this.$parent.selected === this.image }
        },
    });

    Vue.component('tags', {
        props: ['store'],
        template: `<div v-bind:class="{ disabledDiv: !this.$parent.selected }">
                        <button v-on:click="addToStore" v-bind:class="{ included: isIncluded() }" >
                        {{ store }}
                      </button>
                  </div>`,
        methods: {
            addToStore() {
                const storeArr = this.$parent.tags.find( obj => obj.text === this.store).images;
                const isIncluded = storeArr.includes(this.$parent.selected);
                if(!isIncluded) {
                    storeArr.push(this.$parent.selected)
                } else {
                    for (let i=storeArr.length-1; i>=0; i--) {
                        if (storeArr[i] === this.$parent.selected) {
                            storeArr.splice(i, 1);
                            break;
                        }
                    }
                }
                console.log('storeArr', storeArr);
            },
            isIncluded() {
                return this.$parent.tags.find((obj) => obj.text === this.store).images.includes(this.$parent.selected);
            }
        }
    });

    Vue.component('v-select', VueSelect.VueSelect);

    Vue.component('download', {
        props: ['store'],
        template: `<button v-on:click="downloadList"> download List </button>`,
        methods: {
            createFile(exportObj, exportName) {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href",     dataStr);
                downloadAnchorNode.setAttribute("download", exportName + ".json");
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            createTextFile(filename, text) {
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            },

            downloadListJson(){
                this.createFile(this.store, 'list')
            },

            downloadList(){

                console.log(this.store);
                let textList = '';

                this.store.forEach((item) => {
                    if ( item.images.length > 0 ) {
                        textList += '-----------------' + '*  ' + item.text + '  *' + '--------------------' + '\n \n';
                        textList += item.images + '\n \n';
                    }
                });

                this.createTextFile('list', textList)
            },
        },

    });

    new Vue({
        el: '#app',
        data: function () {
            return { images: images, index: null, newStore: '', tags: [], selected: '', filtered: null,
            filteredImages: null};
        },
        methods: {
            addStore() {
                if (this.tags.findIndex(tag => tag.text === this.newStore) === -1) {
                    this.tags.push({text: this.newStore, selected: false, images: []});
                    this.newStore = '';
                } else {
                    console.log('tag exist')
                }
            },

            selectImage(img) {
                this.selected = img
            },
            getTags() {
                return this.tags.map(t => t.text)
            }
    },
        watch: {
            tags: {
                handler() {
                    console.log('Store changed!');
                    console.log(this.tags);
                    console.log(JSON.parse(JSON.stringify(this.tags)));
                    console.log('this.store', this.store)
                },
                deep: true,
            },
            filtered: {
                handler() {

                    if(this.filtered) {
                        console.log('this.filtered', this.filtered)
                        console.log('this.tags', this.tags)
                        const filteredImages = this.tags.find(t => t.text === this.filtered).images
                        console.log('filteredImages', filteredImages)
                        if(filteredImages.length > 0) {
                            this.filteredImages = filteredImages
                        }
                    } else {
                        this.filteredImages = null
                    }
                }
            }
        },
    });
</script>

</body>
</html>